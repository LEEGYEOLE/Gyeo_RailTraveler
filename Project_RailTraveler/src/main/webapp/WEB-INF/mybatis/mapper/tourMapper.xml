<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tour">

	<select id="tourList" parameterType="map" resultType="com.railer.rt.tour.Tour">
		select NVL(tbm.userid,'no') likeuserId, NVL(tbm.tourNum,0) liketourNum,t.tournum , t.stanum, t.detailcatenum, t.name, t.tel , t.address ,t.content, t.longitude,t.latitude, t.hitcount,tf.imagefilename,tc.catenum
		from tour t join tourfile tf on t.tournum = tf.tournum
		join detailtourcategory dtc on t.detailcatenum = dtc.detailcatenum
		join tourcategory tc on dtc.catenum = tc.catenum 
        join station st on st.stanum = t.stanum
        join location loc on loc.locnum =st.locnum
		left join tourbookmark tbm on tbm.tourNum = t.tournum
		<where>
			 loc.locNum = #{locNum}
			<if test="cateNum !=0">
				and tc.catenum = #{cateNum} 
			</if>
		</where>
		and ROWNUM <![CDATA[ < ]]>  1000
		ORDER BY t.tournum DESC
		OFFSET #{offset} ROWS FETCH FIRST #{items} ROWS ONLY
	</select>
	
	<select id="tourCategoryList" resultType="com.railer.rt.tour.Tour">	
	 select cateNum , cateName from tourcategory
	</select>
	
	
	<select id="dataCount" parameterType="map" resultType="Integer">	
	 	select nvl(count(*),0)
		from tour t join tourfile tf on t.tournum = tf.tournum
		join detailtourcategory dtc on t.detailcatenum = dtc.detailcatenum
		join tourcategory tc on dtc.catenum = tc.catenum 
        join station st on st.stanum = t.stanum
        join location loc on loc.locnum =st.locnum

		<where>
			
			<choose>

				<when test = "name == 0">

					loc.locNum = #{locNum}
					<if test="cateNum !=0">
						and tc.catenum = #{cateNum} 
					</if>

				</when>

				<otherwise>

 				t.stanum =#{staNum} and t.detailcatenum=#{detailcateNum}		

				</otherwise>

			</choose>
		</where>

	</select>
	
	<select id="localStation" parameterType="Integer" resultType="com.railer.rt.tour.Tour">
		select staName, staNum from station where locnum = #{locNum}
	</select>
	
	<select id="detailTourCategory" parameterType="map" resultType="com.railer.rt.tour.Tour">
	 select detailcateNum, detailcateName from detailtourcategory where catenum =#{cateNum}
	</select>
	
	<select id="detailTourList" parameterType ="map" resultType="com.railer.rt.tour.Tour">
	select t.tournum , t.stanum, t.detailcatenum, t.name, t.tel , t.address ,t.content, t.longitude,t.latitude, t.hitcount,tf.imagefilename,tc.catenum 
	from tour t 
	join tourfile tf on tf.tournum =t.tournum
	join station s on t.stanum = s.stanum 
	join detailtourcategory d on t.detailcatenum = d.detailcatenum 
	join tourcategory tc on d.catenum = tc.catenum 
	where t.stanum =#{staNum} and t.detailcatenum=#{detailcateNum}
	ORDER BY t.tournum DESC
	OFFSET #{offset} ROWS FETCH FIRST #{items} ROWS ONLY
	</select>
	
	<insert id="likeTour" parameterType="map">
		insert into tourbookmark(tournum,userId) values (#{tourNum},#{userId})
	</insert>
	
	<delete id="cancelLikeTour" parameterType="map">
		delete from tourbookmark where tournum = #{tourNum} and userId =#{userId}
	</delete>
	
	<select id="checkLike" parameterType="map" resultType="Integer">
		select nvl(count(*),0)  from tourbookmark where tournum =#{tourNum} and userId =#{userId}
	</select>
	
	<select id="initLikeMark" parameterType="map" resultType="Integer">
		select tournum from tourbookmark where userId =#{userId}
	</select>

	<select id="hitContentList" parameterType="map" resultType="com.railer.rt.tour.Tour">
			select tb.tournum tournum, likecount , ttf.imagefilename imagefilename from
			(select  tf.tournum tournum, nvl(count(*),0) likeCount from tour t
			join tourfile tf on t.tournum = tf.tournum
			join tourbookmark tbm on tbm.tournum =t.tournum
			join station s  on s.stanum =t.stanum
			join location loc on s.locnum = loc.locnum
			where s.locnum =#{locNum}
			group by tf.tournum
			order by likeCount desc) tb join tourfile ttf
			on tb.tournum = ttf.tournum 
			where rownum <![CDATA[<]]>10
	</select>
	
	<select id="readDetailTour" parameterType="Integer" resultType="com.railer.rt.tour.Tour">
        select tf.imagefilename, t.stanum,t.detailcateNum,name,tel,address,content,longitude,latitude,hitCount,detailcatename 
        from tour t 
        join detailtourcategory dtc on dtc.detailcatenum =t.detailcatenum 
        join tourfile tf on t.tournum = tf.tournum    
		 where t.tourNum = #{tourNum}		
	</select>






	
</mapper>